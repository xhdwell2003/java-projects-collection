# 分子分母粒度推断

## 推断分子力度

- 找到输出列中的GB，DF列
- 如果没有GB就是汇总
    - 数据项取sum：开头的
    - 如果是比例型的分母也是汇总，数据项取mean：开头的
- 如果有GB列
    - 查维度字典
        - 将维度和单子的字典都保存下来。
    - 先判断维度汇总
        - 如果GB列的每项都在维度列表内
            - 则为维度汇总
            - 分子数据项取df中sum：开头的
            - 分母的力度为汇总
            - 分母数据项为mean：开头的
    - 在判断单只
        - GB列在单只的字典中则为单只
        - 比例型
            - 分子项取df中sum：开头的
            - 分母粒度为汇总
            - 分母数据项mean：开头的
        - 非比例型
            - DF只有一项
                - 如果输出项sum：开头
                    - 数值型
                - 如果输出项head：开头
                    - 禁投型
            - df有两个
                - 输出结果间比较
                    - 第一个输出项为head：开头的
                    - 第二个输出项
                        - 过滤第一个后剩下的head：开头的
            - df有三个
                - 日期区间
                    - 先取df里以interval：开头的
                    - 如果中间有#，如A#B
                        - 第一个输出项为#号前面的字段A，对应的df输出列中head：开头的
                    - 第二个输出项为#号后面的字段B，对应的df输出列中head：开头的
- 分子分母相同度量
    - 比例型，但是index度量树没有out
        - 特殊处理
            - 如果输出项以 “持仓数量/”或者“持仓市值/”开头的
                - 分母分子的条件相同
    - 普通情况
        - 根据filter_expr表中的expr字段中的out进行拆分
            - 前面是分子的条件
            - 后面的分母的条件
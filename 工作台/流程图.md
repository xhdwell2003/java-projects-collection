# 任务处理流程

## 操作类型

### 新增
1. 描述：创建新的任务记录
2. 流程：
   - 根据业务ID+任务类型检查是否已存在任务
   - 如果存在任务：
     * 修改原任务
     * 删除原任务的待处理节点
     * 增加当前节点并标记为"已完成"
     * 分配下一节点（遵循通用权限分配规则）
     * 标记下一节点为"处理中"
     * 更新任务状态为"处理中"
   - 如果不存在任务：
     * 新建任务实例
     * 新增当前节点并标记为"已完成"
     * 分配下一节点（遵循通用权限分配规则）
     * 标记下一节点为"处理中"
     * 设置任务状态为"处理中"
   - 记录操作人和操作时间

### 修改
1. 描述：更新现有任务信息
2. 流程：
   - 根据业务ID+任务类型检查是否已存在任务
   - 如果存在任务：
     * 删除原任务的待处理节点
     * 增加当前节点并标记为"已完成"
     * 分配下一节点（遵循通用权限分配规则）
     * 标记下一节点为"处理中"
     * 更新任务状态为"处理中"
   - 如果不存在任务：
     * 新建任务实例
     * 新增当前节点并标记为"已完成"
     * 分配下一节点（遵循通用权限分配规则）
     * 标记下一节点为"处理中"
     * 设置任务状态为"处理中"
   - 记录操作人和操作时间

### 删除
1. 描述：删除任务记录
2. 流程：
   - 根据业务ID+任务类型检查是否已存在任务
   - 如果存在任务：
     * 修改当前节点状态为"已删除"
     * 更新任务状态为"已完成"
   - 如果不存在任务：
     * 新建任务实例
     * 添加经办节点并标记为"已删除"
     * 设置任务状态为"已完成"
   - 记录操作人和操作时间

### 审核
1. 描述：对任务进行审核操作
2. 流程：
   - 根据业务ID+任务类型检查是否已存在任务
   - 如果存在任务：
     * 修改当前节点为"已通过"
     * 更新任务状态为"已完成"
   - 如果不存在任务：
     * 新建任务实例
     * 添加当前节点并标记为"已通过"
     * 设置任务状态为"已完成"
   - 记录审核人和操作时间

### 反审核
1. 描述：撤销任务的审核状态
2. 流程：
   - 根据业务ID+任务类型检查是否已存在任务
   - 如果存在任务：则跳过不生成任务
   - 如果不存在任务: 新建任务实例
   - 添加反审核节点并标记为"已通过"
   - 生成维护类型节点并标记为"处理中"
   - 记录反审核操作人和操作时间

## 通用规则
1. 动态流程配置：
   - 当接口传入指定的下一节点参数时，将采用指定节点作为待处理节点
   - 未传入指定节点参数时，采用默认配置流程
   - 指定下一节点是FINISH类型时,强制完成任务,任务状态为"已完成",节点状态为"已通过"
   - 指定节点需通过有效性验证
   - 记录节点变更原因和操作人
2. 权限分配规则：
   - 特殊处理人优先判断:
     * 当节点配置了特殊处理人时，直接使用特殊处理人作为处理人
     * 跳过后续权限判断流程
   - 无特殊处理人时的权限判断流程:
     * 用户权限维度:
       + 根据节点权限码加上产品代码获取对应的有权限的业务人员
       + 如果产品代码不存在则不控产品维度
     * 机构维度:
       + 如果节点配置中配置了机构且机构范围为"只判断配置机构":
         - 根据节点配置的机构获取机构人员
       + 如果节点配置中配置了机构且机构范围为"合并判断":
         - 获取节点配置机构和发起人机构的并集人员
       + 如果节点机构没有配置:
         - 直接取发起人机构获取人员
     * 取用户权限维度和机构维度的交集作为最终处理人候选
   - 其他规则:
     * 维护节点判断处理人自动剔除当前操作人
     * 其他节点分配处理人无需剔除当前操作人
     * 分配符合条件的处理人
3. 幂等性规则：
   - 新增操作幂等处理:
     * 保存时需要查询是否已经存在业务ID+任务类型相同的处理中任务,如果存在则做节点添加而非新建任务
   - 更新操作必须基于最新数据：
     * 节点和任务更新时必须校验updatetime字段
   - 操作前数据校验：
     * 从数据库获取当前任务和节点的最新updatetime
     * 与客户端传入的updatetime进行严格比对
   - 一致性检查：
     * 只有updatetime完全匹配时才允许执行后续操作
     * 不匹配时立即终止当前操作
   - 错误处理：
     * 当updatetime不一致时返回明确错误信息："数据已被修改，请刷新后重试"
     * 记录操作冲突日志用于审计
4. 节点状态更新规则：
   - 当前节点处理完成后：
     * 将当前操作人对应的节点状态更新为"已通过"
     * 将其他操作人对应的节点状态更新为"废弃"
     * 记录状态变更时间和操作人

### 任务处理流程测试要点

本文档根据`流程图.md`中的业务逻辑，梳理核心测试要点。

---

### 一、 操作类型测试

#### 1. 新增/修改操作
*   **场景1：任务已存在**
    *   **操作**: 对一个已存在的`业务ID+任务类型`组合执行新增或修改操作。
    *   **预期结果**:
        *   系统不会创建新的任务实例。
        *   原任务中状态为"处理中"的节点被删除或标记为废弃。
        *   流程中新增一个表示当前操作的节点，并标记为"已完成"。
        *   根据权限分配规则，生成新的下一节点，并标记为"处理中"。
        *   任务的总体状态更新为"处理中"。
        *   操作人和操作时间被正确记录。

*   **场景2：任务不存在**
    *   **操作**: 对一个全新的`业务ID+任务类型`组合执行新增或修改操作。
    *   **预期结果**:
        *   系统成功创建一个新的任务实例。
        *   流程中新增一个表示当前操作的节点，并标记为"已完成"。
        *   根据权限分配规则，生成新的下一节点，并标记为"处理中"。
        *   任务的总体状态设置为"处理中"。
        *   操作人和操作时间被正确记录。

#### 2. 删除操作
*   **场景1：任务已存在**
    *   **操作**: 对一个已存在的`业务ID+任务类型`组合执行删除操作。
    *   **预期结果**:
        *   当前节点状态更新为"已删除"。
        *   任务的总体状态更新为"已完成"。
        *   操作人和操作时间被正确记录。

*   **场景2：任务不存在**
    *   **操作**: 对一个全新的`业务ID+任务类型`组合执行删除操作。
    *   **预期结果**:
        *   系统新建一个任务实例。
        *   添加一个经办节点，并直接标记为"已删除"。
        *   任务的总体状态设置为"已完成"。
        *   操作人和操作时间被正确记录。

#### 3. 审核操作
*   **场景1：任务已存在**
    *   **操作**: 对一个已存在的`业务ID+任务类型`组合执行审核操作。
    *   **预期结果**:
        *   当前节点状态修改为"已通过"。
        *   任务的总体状态更新为"已完成"。
        *   审核人和操作时间被正确记录。

*   **场景2：任务不存在**
    *   **操作**: 对一个全新的`业务ID+任务类型`组合执行审核操作。
    *   **预期结果**:
        *   系统新建一个任务实例。
        *   添加一个当前节点，并直接标记为"已通过"。
        *   任务的总体状态设置为"已完成"。
        *   审核人和操作时间被正确记录。

#### 4. 反审核操作
*   **场景1：任务已存在**
    *   **操作**: 对一个已存在的`业务ID+任务类型`组合执行反审核操作。
    *   **预期结果**:
        *   系统跳过，不生成任何新任务或节点。

*   **场景2：任务不存在**
    *   **操作**: 对一个全新的`业务ID+任务类型`组合执行反审核操作。
    *   **预期结果**:
        *   系统新建一个任务实例。
        *   添加一个反审核节点，并标记为"已通过"。
        *   自动生成一个维护类型的节点，并标记为"处理中"，分配给相应处理人。
        *   反审核操作人和操作时间被正确记录。

---

### 二、 通用规则测试

#### 1. 动态流程配置
*   **场景1**: 接口传入指定的、合法的下一节点参数。
    *   **预期结果**: 流程无视默认配置，直接流向指定的待处理节点。
*   **场景2**: 接口未传入下一节点参数。
    *   **预期结果**: 流程按照预设的默认配置进行流转。
*   **场景3**: 接口传入的指定节点为`FINISH`类型。
    *   **预期结果**: 任务被强制完成，任务状态变为"已完成"，当前节点状态变为"已通过"。
*   **场景4**: 接口传入一个无效的、非法的节点参数。
    *   **预期结果**: 操作失败，系统返回错误信息，提示节点无效。
*   **数据验证**: 任何由于动态指定的节点变更，都应记录变更原因和操作人。

#### 2. 权限分配规则
*   **场景1**: 节点配置了特殊处理人。
    *   **预期结果**: 任务直接分配给该特殊处理人，忽略其他所有权限规则。
*   **场景2**: 无特殊处理人，仅根据用户权限维度判断（产品代码存在/不存在）。
    *   **预期结果**: 处理人是拥有节点权限码和对应产品代码权限的用户。
*   **场景3**: 无特殊处理人，根据机构维度判断。
    *   **预期结果**:
        *   **只判断配置机构**: 处理人必须属于节点上配置的机构。
        *   **合并判断**: 处理人可以是节点配置机构或发起人机构的成员。
        *   **无配置机构**: 处理人取自发起人所在的机构。
*   **场景4**: 用户权限和机构维度取交集。
    *   **预期结果**: 最终处理人必须同时满足用户权限和机构维度的要求。
*   **场景5**: 节点为"维护节点"。
    *   **预期结果**: 分配处理人时，会自动剔除当前操作人。
*   **场景6**: 节点为其他类型节点。
    *   **预期结果**: 分配处理人时，不过滤当前操作人。

#### 3. 幂等性规则
*   **场景1**: 客户端A打开任务，客户端B处理了该任务，然后客户端A提交处理。
    *   **预期结果**: 客户端A的操作失败，收到"数据已被修改，请刷新后重试"的错误提示。数据库中任务状态应为B操作后的结果。
*   **场景2**: 快速连续两次提交相同的"新增"操作。
    *   **预期结果**: 系统只创建一个任务实例，第二次操作被视为对第一次创建任务的更新，而不是创建新任务。

#### 4. 节点状态更新规则
*   **场景1**: 某个节点有多个处理人（A, B, C），其中A完成了处理。
    *   **预期结果**:
        *   处理人A对应的节点状态更新为"已通过"。
        *   处理人B和C对应的节点状态更新为"废弃"。
        *   状态变更时间和操作人A被正确记录。

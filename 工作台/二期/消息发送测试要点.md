# 消息发送测试要点

## 1. 概述

本文档基于《消息发送业务流程》设计，旨在提供一份全面的测试要点清单，以确保消息生成、发送、重试及状态管理的逻辑正确无误。

## 2. 测试范围

- **消息任务生成**：覆盖分行、总行值班、总行非值班等场景。
- **消息发送与重试**：覆盖首次发送成功、发送失败、多次重试、达到重试上限等场景。
- **平台隔离**：“天元”和“招呼”平台任务的独立性测试。
- **数据一致性**：验证数据库中消息记录的状态和字段在各个环节的准确性。
- **日志记录**：验证流程各环节的日志是否完整、准确。

---

## 3. 消息任务生成测试要点

**前置条件**：准备好不同类型的用户数据（分行用户、总行用户），并配置好值班表（例如，设置周一某总行用户值班）。

- **场景1：分行人员**
  - **操作**: 触发一个给“分行人员”发送消息的事件。
  - **预期结果**:
    1.  在 `MESSAGE_SEND_LOG` 表中成功创建一条新的消息记录。
    2.  该记录的 `status` 应为 “待发送”。
    3.  `retry_count` 应为 `0`。

- **场景2：总行人员（值班）**
  - **操作**: 在其值班日（例如周一），触发一个给“总行值班人员”发送消息的事件。
  - **预期结果**:
    1.  在 `MESSAGE_SEND_LOG` 表中成功创建一条新的消息记录。
    2.  该记录的 `status` 应为 “待发送”。
    3.  `retry_count` 应为 `0`。

- **场景3：总行人员（非值班）**
  - **操作**: 在其非值班日，触发一个给“总行人员”发送消息的事件。
  - **预期结果**:
    1.  `MESSAGE_SEND_LOG` 表中 **不应** 创建任何与此事件相关的记录。
    2.  （可选）检查日志，应有“总行非值班人员，不生成消息”等相关`DEBUG`级别的日志记录。

- **场景4：总行人员（当天无值班安排）**
  - **操作**: 清空当天的值班表记录，触发一个给任意“总行人员”发送消息的事件。
  - **预期结果**:
    1.  `MESSAGE_SEND_LOG` 表中 **不应** 创建任何记录。
    2.  检查日志，应有 `DUTY_SCHEDULE_NOT_CONFIGURED` 等相关的警告日志。

---

## 4. 消息发送与重试测试要点

**前置条件**：需要能够模拟“天元”和“招呼”平台接口的响应（成功/失败）。

- **场景1：首次发送成功**
  - **准备**: 手动在数据库插入一条 `status` 为“待发送”的记录（例如，平台为“天元”）。模拟天元接口返回成功。
  - **操作**: 手动触发或等待“天元消息发送定时任务”执行。
  - **预期结果**: 该记录的 `status` 更新为 “发送成功”。

- **场景2：发送失败，一次重试后成功**
  - **准备**: 插入一条“待发送”记录。首次调用时模拟接口返回失败，第二次调用时模拟接口返回成功。
  - **操作1**: 触发定时任务第一次执行。
  - **预期结果1**: 记录的 `status` 更新为 “发送失败”，`retry_count` 更新为 `1`。
  - **操作2**: 触发定时任务第二次执行。
  - **预期结果2**: 记录的 `status` 更新为 “发送成功”，`retry_count` 保持为 `1`。

- **场景3：发送失败，达到最大重试次数**
  - **准备**: 插入一条“待发送”记录。模拟接口始终返回失败。
  - **操作1 (第一次执行)**: 触发定时任务。
  - **预期结果1**: `status` 变为 “发送失败”，`retry_count` 变为 `1`。
  - **操作2 (第二次执行)**: 触发定时任务。
  - **预期结果2**: `status` 保持 “发送失败”，`retry_count` 变为 `2`。
  - **操作3 (第三次执行)**: 触发定时任务。
  - **预期结果3**: `status` 变为 **“停止重试”**，`retry_count` 变为 `3`。

- **场景4：任务不再处理“停止重试”的记录**
  - **准备**: 基于场景3的结果，数据库中已有一条 `status` 为“停止重试”的记录。
  - **操作**: 再次触发定时任务。
  - **预期结果**: 定时任务不应查询到该记录，该记录的任何字段（特别是`update_time`）都不应发生变化。

---

## 5. 平台隔离与并发测试

- **场景1：平台任务隔离**
  - **准备**: 同时在数据库中插入两条“待发送”记录，一条 `platform` 为“天元”，另一条为“招呼”。
  - **操作**: 只触发“天元消息发送定时任务”。
  - **预期结果**:
    1.  “天元”平台的消息记录状态被正确更新（例如变为“发送成功”）。
    2.  “招呼”平台的消息记录应保持“待发送”状态，未受任何影响。

- **场景2：批量处理**
  - **准备**: 在数据库中插入多条（例如10条）状态为“待发送”的同平台记录。
  - **操作**: 触发一次定时任务。
  - **预期结果**: 所有10条记录都应被处理，并根据各自模拟的接口响应结果更新状态。

---

## 6. 数据与日志验证

- **数据验证**: 在执行上述每一个测试场景后，都应检查 `MESSAGE_SEND_LOG` 表中的相关记录，验证 `status`, `retry_count`, `update_time` 等字段的正确性。
- **日志验证**: 
  - 检查应用日志，确认任务的生成、发送尝试、成功、失败、重试等关键节点都有清晰的日志输出。
  - 在失败场景下，确认日志中记录了详细的错误信息。

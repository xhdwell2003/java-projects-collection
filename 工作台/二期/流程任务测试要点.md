# 流程任务测试要点

## 1. 概述

本文档旨在根据《流程任务创建业务流程》和《流程任务完成业务流程》的描述，提供一份全面的测试要点清单。测试范围覆盖从任务创建到任务完成的整个生命周期，确保流程的正确性、稳定性和数据一致性。

## 2. 测试范围

- **流程任务创建**：包括任务类型判断、流程实例处理、任务生成条件、权限分配等。
- **流程任务完成**：包括任务状态变更、后续单任务及并行任务的生成、流程最终状态的判断等。
- **异常处理**：覆盖各类业务异常和系统异常场景。
- **数据验证**：确保流程、任务、节点等相关数据在各个环节的一致性和准确性。

---

## 3. 流程任务创建测试要点

### 3.1 任务类型判断

- 创建一个“非流程所属任务”。
  - **预期结果**: 系统应按照普通任务逻辑处理，不创建流程实例。
- 创建一个“流程所属任务”。
  - **预期结果**: 系统应进入流程处理逻辑，开始创建或获取流程实例。

### 3.2 流程处理

- 首次为某个业务ID创建任务（流程实例不存在）。
  - **预期结果**:
    1.  成功创建一个新的流程实例。
    2.  新流程实例的初始状态为“待处理”。
    3.  正确记录流程的创建时间、创建人等信息。
- 为一个已存在“待处理”或“处理中”状态流程的业务ID创建新任务。
  - **预期结果**: 系统应复用现有流程实例，不创建新流程。
- 尝试为一个已“已完成”或“已终止”的流程创建新任务。
  - **预期结果**: 系统应拒绝创建任务，并提示错误信息：“流程已结束，无法创建新任务”。

### 3.3 任务生成判断

- 创建流程的第一个任务（初始任务）。
  - **预期结果**: 任务应直接生成，状态为“处理中”。
- 创建一个非初始任务，且其所有前置任务均已完成。
  - **预期结果**: 任务应成功生成，状态为“处理中”。
- 创建一个非初始任务，但其存在未完成的前置任务。
  - **预期结果**: 任务创建失败，并提示错误信息：“前置任务未完成，无法生成当前任务”。

### 3.4 任务更新逻辑

- 尝试创建一个与现有任务完全相同（业务ID + 任务类型）的任务。
  - **预期结果**: 系统不应创建新任务，而是执行更新操作，并正确记录更新时间、更新人等信息。

### 3.5 权限分配

- 任务节点配置了“特殊处理人”。
  - **预期结果**: 任务应直接分配给该特殊处理人。
- 任务节点未配置特殊处理人，但配置了权限码和机构。
  - **预期结果**: 处理人应为同时满足“拥有节点权限码”和“属于指定机构”的人员交集。
- 任务节点为“维护节点”。
  - **预期结果**: 最终的候选处理人中应剔除当前操作人。
- 任务节点未配置机构，但配置了权限码。
  - **预期结果**: 处理人应为拥有节点权限码且属于“发起人所在机构”的人员。

### 3.6 任务节点创建

- 成功创建一个任务后，验证其后续节点。
  - **预期结果**:
    1.  当前任务的节点被创建，状态为“处理中”。
    2.  如果存在下一个节点，应同时被创建，状态为“待处理”.

---

## 4. 流程任务完成测试要点

### 4.1 任务状态与后续处理

- 完成一个“非流程任务”。
  - **预期结果**: 走单任务处理环节，不触发流程逻辑。
- 完成一个流程任务，但该任务完成后自身状态未能变为“已完成”。
  - **预期结果**: 流程中断，不生成后续任务。
- 完成一个流程任务，且该任务有唯一的后续任务。
  - **预期结果**:
    1.  当前任务状态变为“已完成”。
    2.  成功生成一个新的后续任务，其业务ID与当前任务相同。
- 完成一个流程任务，但该任务是流程分支的最后一个任务，且整个流程还未结束。
  - **预期结果**:
    1.  当前任务状态变为“已完成”。
    2.  不生成新任务。
    3.  整个流程的状态保持“处理中”。

### 4.2 并行任务处理

- 完成一个流程任务，其后有多个并行的后续任务。
  - **预期结果**:
    1.  当前任务状态变为“已完成”。
    2.  所有并行的后续任务都应被同时生成。

### 4.3 流程完成判断

- 完成流程中的最后一个任务。
  - **预期结果**:
    1.  当前任务状态变为“已完成”。
    2.  整个流程的状态自动更新为“已完成”。

---

## 5. 异常处理与数据验证

### 5.1 异常场景

- 在任务创建/完成过程中，模拟数据库连接断开等系统异常。
  - **预期结果**: 系统应能捕获异常，记录关键日志，并执行事务回滚，保证数据一致性。
- 并发创建/完成同一个业务ID的任务。
  - **预期结果**: 系统应通过锁机制（如乐观锁）保证数据处理的正确性，避免出现数据错乱。

### 5.2 数据验证

- 在每个测试用例执行后，检查数据库。
  - **预期结果**:
    1.  `流程实例表`：状态、更新时间等字段符合预期。
    2.  `任务实例表`：状态、处理人、起止时间等字段符合预期。
    3.  `任务节点表`：节点状态、关系等字段符合预期。
    4.  `日志表`：操作日志、异常日志被正确、完整地记录。
# 工作台任务完成情况统计视图设计

## 1. 概述

为了直观、高效地监控各机构每日任务的完成情况，特设计此统计视图。该视图旨在通过图形化界面，按机构维度清晰展示“每日流程”、“参数规则”、“新增产品”、“过期产品”及“其他”五大类任务的完成率，并进行排序，为管理者提供决策支持。

### 1.1 核心目标

- **量化进度**：将各机构的任务完成情况以“完成率”指标进行量化。
- **直观对比**：通过降序排序的柱状图，快速识别任务完成率高和低的机构。
- **聚焦关键**：明确定义任务完成的标准（当天完成且时间早于18:00），确保统计口径的一致性。

---

## 2. 视图设计

### 2.1 页面布局

页面主要分为两个区域：筛选区和数据展示区。

```text
+----------------------------------------------------+
| 筛选区                                             |
|                                                    |
| 统计日期: [________] (日期选择器)   [查询] (按钮)  |
|                                                    |
+----------------------------------------------------+
| 数据展示区                                         |
|                                                    |
| ▼ 各机构任务完成率 (降序)                          |
|                                                    |
|  机构A ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ 95%                 |
|  机构B ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ 80%                     |
|  机构C ▇▇▇▇▇▇▇▇▇▇▇▇▇ 65%                         |
|  ...                                               |
|                                                    |
| -------------------------------------------------- |
| | 排名 | 机构名称 | 完成率 | 总任务数 | 完成数 |   |
| |------|----------|--------|----------|--------|   |
| | 1    | 机构A    | 95%    | 100      | 95     |   |
| | 2    | 机构B    | 80%    | 120      | 96     |   |
| | ...  | ...      | ...    | ...      | ...    |   |
+----------------------------------------------------+
```

### 2.2 筛选条件

- **统计日期**：日期选择器，必填，默认值为“今天”。用户可以选择任意一天来查看当天的统计数据。

### 2.3 展示内容

1.  **柱状图 (Bar Chart)**
    -   **Y轴**: 机构名称。
    -   **X轴**: 完成率（%）。
    -   **排序**: 所有机构按照完成率从高到低（降序）排列。
    -   **数据标签**: 每个柱状图的末端显示该机构的具体完成率数值。

2.  **数据表格**
    -   在图表下方，以表格形式展示详细数据，与图表排序一致。
    -   **列**：排名、机构名称、完成率、总任务数、完成任务数。

---

## 3. 核心逻辑与计算规则

### 3.1 数据源

- 核心数据来源于两张独立的表：
    1.  **流程实例表 (FLOW_INSTANCE)**: 存储“每日流程”、“产品新增”等流程的实例信息。
    2.  **任务实例表 (TASK_INSTANCE)**: 存储“参数规则”、“过期产品”、“其他”等独立任务的实例信息。
- 需要的关键字段（两表结构类似）：`id`, `org_id` (机构ID), `category` (分类), `status` (状态), `update_time` (最后更新时间)。

### 3.2 统计模式区分

根据任务分类的不同，从不同的数据源采用相应的统计模式：

1.  **流程维度统计 (Process-based Statistics)**
    -   **数据源**: `FLOW_INSTANCE` 表。
    -   **适用分类**: `每日流程`, `产品新增`。
    -   **说明**: 在此模式下，`FLOW_INSTANCE` 表中的每一条记录代表一个完整的端到端业务流程。统计的目标是衡量整个流程的完成情况。

2.  **任务维度统计 (Task-based Statistics)**
    -   **数据源**: `TASK_INSTANCE` 表。
    -   **适用分类**: `参数规则`, `其他`, `过期产品`。
    -   **说明**: 在此模式下，`TASK_INSTANCE` 表中的每一条记录代表一个独立的、原子的工作任务。统计的目标是衡量这些独立任务的完成情况。

### 3.3 统计口径定义

- **当日实例总数**: (当日`FLOW_INSTANCE`表中的相关流程数) + (当日`TASK_INSTANCE`表中的相关任务数)。
- **当日完成实例数**: 对两张表中的每一个实例，“完成”的判断标准是统一的，必须同时满足以下三个条件：
    1.  实例的 `status` 为 **“已完成”**。
    2.  实例的 `update_time` 的日期部分等于“统计日期”。
    3.  实例的 `update_time` 的时间部分早于 **18:00:00**。

### 3.4 完成率计算公式

对每个机构进行独立计算：

`完成率 = (机构当日完成实例数 / 机构当日实例总数) * 100%`

- **特殊处理**: 如果某机构当日实例总数为0，则其完成率也为0。

---

## 4. 数据接口设计 (API)

### 4.1 后端接口

提供一个用于获取统计数据的HTTP GET接口。

`GET /api/v1/workbench/statistics/completion-rate`

#### 4.1.1 请求参数

| 参数名 | 类型   | 是否必须 | 描述               |
|--------|--------|----------|--------------------|
| `date` | String | 是       | 统计日期 (格式: YYYY-MM-DD) |

#### 4.1.2 响应数据 (JSON)

返回一个按 `completionRate` 降序排序的对象数组。

```json
{
  "data": [
    {
      "rank": 1,
      "orgName": "机构A",
      "completionRate": 95.00,
      "totalTasks": 100,
      "completedTasks": 95
    },
    {
      "rank": 2,
      "orgName": "机构B",
      "completionRate": 80.00,
      "totalTasks": 120,
      "completedTasks": 96
    },
    // ... more organizations
  ]
}
```

---

## 5. SQL 实现伪代码

由于数据源被分离为`FLOW_INSTANCE`和`TASK_INSTANCE`两张表，需要使用`UNION ALL`来合并两部分数据，然后再进行最终的聚合统计。

```sql
-- 定义统计日期变量
SET @target_date = '2025-09-29';

-- 最终聚合查询
SELECT
    t.org_name,
    COUNT(t.id) AS total_tasks, -- 统计总实例数
    SUM(t.is_completed) AS completed_tasks, -- 统计总完成数
    (SUM(t.is_completed) / COUNT(t.id)) * 100 AS completion_rate -- 计算完成率
FROM (
    -- 第一部分：从FLOW_INSTANCE表查询流程数据
    SELECT
        fi.id, -- 流程ID
        oi.org_name,
        CASE
            WHEN fi.status = '已完成' AND DATE(fi.update_time) = @target_date AND TIME(fi.update_time) < '18:00:00'
            THEN 1
            ELSE 0
        END AS is_completed
    FROM
        FLOW_INSTANCE fi
    JOIN
        ORGANIZATION_INFO oi ON fi.org_id = oi.org_id
    WHERE
        DATE(fi.create_time) = @target_date AND
        fi.category IN ('每日流程', '产品新增')

    UNION ALL

    -- 第二部分：从TASK_INSTANCE表查询任务数据
    SELECT
        ti.id, -- 任务ID
        oi.org_name,
        CASE
            WHEN ti.status = '已完成' AND DATE(ti.update_time) = @target_date AND TIME(ti.update_time) < '18:00:00'
            THEN 1
            ELSE 0
        END AS is_completed
    FROM
        TASK_INSTANCE ti
    JOIN
        ORGANIZATION_INFO oi ON ti.org_id = oi.org_id
    WHERE
        DATE(ti.create_time) = @target_date AND
        ti.category IN ('参数规则', '过期产品', '其他')
) AS t
GROUP BY
    t.org_name -- 按机构名称分组
ORDER BY
    completion_rate DESC; -- 按完成率降序排序
```

## 隔离仓模式

隔离仓模式是一种将不同类型任务（如长任务与常规任务）在系统中进行物理或逻辑隔离的设计方法。对于监督系统中的跑批线程，采用隔离仓模式可以有效避免长任务阻塞常规任务，提升系统的稳定性与可维护性。

### 主要思路

- **线程池隔离**：为长任务和常规任务分别分配独立的线程池，互不影响。
- **资源分配**： 长任务分配1个线程，常规任务2个线程。任务抢占长任务保证每个节点不超过一个处理的长任务。

## 流量隔离

流量隔离主要针对不同类型的业务流量进行区分和管理。通过识别和分类各类任务（如工作台任务、事中任务、事后任务等），可以根据任务的重要性和资源需求，制定相应的隔离策略，防止低优先级或高资源消耗的任务影响核心业务流程。

### 主要思路

- **服务拆分**：将 monservice 服务进行拆分，分别处理工作台与事中事后任务。
- **域名分离**：为不同类型的任务分配独立域名，实现访问隔离。
- **核心业务保护**：通过隔离，确保非重要任务不会影响核心业务的稳定性与性能。

## 重试机制

针对穿透估值表、MONGZ_BD 等大数据推送经常延迟的问题，需要引入重试跑批机制以兜底，减少业务手工操作和运维压力。

### 主要思路

- **自动检查**：在业务办理时点（如 8:30）之前，系统自动检查数据和跑批任务状态。
- **失败重试**：若发现跑批任务失败但数据已完整，说明数据晚于跑批时间到达，系统将自动触发重跑任务。
- **减少人工干预**：通过自动重试机制，降低因数据延迟导致的人工补救操作，提高系统的自动化和稳定性。

## 业务异常自愈机制

### 指标计算异常自愈

- **触发条件**：指标计算过程中出现异常，如公式解析错误、数据源连接失败、计算结果超出合理范围等。
- **自愈措施**：
  - **自动降级**：当主要计算方式失败时，自动切换到备选计算方案或简化算法，确保基础指标可用。
  - **结果缓存**：在计算成功时缓存结果，当计算失败时自动使用最近的有效结果作为临时替代。
  - **异常隔离**：将异常指标的计算过程隔离，避免影响其他正常指标的计算。
- **实施建议**：建立指标计算的健康度评估机制，设置合理的降级策略和缓存有效期。

### 数据同步异常自愈

- **触发条件**：数据同步过程中出现异常，如数据源变更、字段映射错误、数据格式不一致等。
- **自愈措施**：
  - **自动重映射**：当检测到字段变更时，系统自动尝试根据字段名称、类型等信息进行智能映射。
  - **数据格式自适应**：支持多种数据格式的自动识别和转换，当源数据格式发生变化时自动调整。
  - **增量补偿**：对于同步失败的数据，系统自动记录并在后续时间点进行补偿同步。
- **实施建议**：建立数据源变更监控机制，设计灵活的数据映射规则和转换策略。

### 业务流程异常自愈

- **触发条件**：业务流程执行过程中出现异常，如审批流程中断、状态转换失败、依赖服务不可用等。
- **自愈措施**：
  - **流程状态自动修复**：定期检查流程状态，发现异常状态时自动尝试修复或回滚到上一正常状态。
  - **依赖服务降级**：当依赖服务不可用时，自动切换到备选服务或跳过非关键步骤。
  - **人工干预点**：在关键节点设置人工干预点，当自动修复失败时，自动生成工单并通知相关人员。
- **实施建议**：梳理业务流程中的关键节点和依赖关系，设计合理的降级和补偿机制。

### 监控指标异常自愈

- **触发条件**：监控指标出现异常波动或超出阈值，如系统性能下降、错误率升高等。
- **自愈措施**：
  - **动态阈值调整**：根据历史数据和业务特点，动态调整监控阈值，减少误报。
  - **根因分析**：结合多个相关指标，自动分析可能的根因，提供针对性的修复建议。
  - **自动修复**：对于常见问题，如内存泄漏、线程阻塞等，系统自动执行预设的修复脚本。
- **实施建议**：建立指标间的关联关系模型，积累常见问题的修复经验。

### 配置变更异常自愈

- **触发条件**：配置变更导致系统异常，如参数设置错误、配置冲突、版本不兼容等。
- **自愈措施**：
  - **配置验证**：在配置生效前进行自动验证，检测潜在的冲突和错误。
  - **快速回滚**：当检测到配置变更导致异常时，自动回滚到上一个稳定版本。
  - **灰度发布**：对于高风险配置变更，自动进行灰度发布，逐步扩大影响范围。
- **实施建议**：建立配置变更的审核和验证机制，设计完善的回滚策略。

## 自愈能力实施建议

1. **业务场景梳理**：针对不同业务场景，识别可能出现的异常情况和自愈需求。
2. **自愈策略设计**：根据业务特点和影响程度，设计合适的自愈策略和触发条件。
3. **监控告警完善**：建立全面的监控告警体系，确保能及时发现异常情况。
4. **自愈能力测试**：定期进行自愈能力的测试和演练，确保自愈机制的有效性。
5. **持续优化改进**：根据实际运行情况，不断优化自愈策略和机制。

通过以上业务相关的自愈机制，可以有效提升系统的稳定性和可靠性，减少人工干预，提高业务连续性。